function SpectrumViewer(a){"string"===typeof a&&(a=document.getElementById(a));d3.select(a).selectAll("*").remove();this.svg=d3.select(a).append("svg").style("width","100%").style("height","100%");this.peptideFragKey=new PeptideFragmentationKey(this.svg,this);this.graph=new Graph(this.svg,this,{xlabel:"m/z",ylabel:"Intensity"});this.peptideFragKey.highlightChanged.add(this.graph.setHighlights).context=this.graph;this.graph.highlightChanged.add(this.peptideFragKey.setHighlights).context=this.peptideFragKey}
SpectrumViewer.cmap=colorbrewer.Paired[6];SpectrumViewer.p1color=SpectrumViewer.cmap[5];SpectrumViewer.p1color_loss=SpectrumViewer.cmap[4];SpectrumViewer.p2color=SpectrumViewer.cmap[1];SpectrumViewer.p2color_loss=SpectrumViewer.cmap[0];SpectrumViewer.lossFragBarColour="#cccccc";SpectrumViewer.highlightColour="yellow";SpectrumViewer.highlightWidth=11;SpectrumViewer.notUpperCase=/[^A-Z]/g;
SpectrumViewer.prototype.setData=function(a,b,c,e,d){this.pep1=a.replace(SpectrumViewer.notUpperCase,"");this.pep2=c.replace(SpectrumViewer.notUpperCase,"");this.annotatedPeaks=d3.csv.parse(d.trim());this.linkPos1=b;this.linkPos2=e;this.lossyShown=!1;this.peptideFragKey.setData(this.pep1,this.linkPos1,this.pep2,this.linkPos2,this.annotatedPeaks);this.graph.setData(this.annotatedPeaks)};SpectrumViewer.prototype.clear=function(){this.pep2=this.pep1="";this.peptideFragKey.clear();this.graph.clear()};
SpectrumViewer.prototype.resize=function(){this.graph.resize()};SpectrumViewer.prototype.getSVG=function(){var a=this.svg[0][0].parentNode.innerHTML,a=a.replace("<svg ",'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:ev="http://www.w3.org/2001/xml-events" ');return'<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+a};
SpectrumViewer.prototype.showLossy=function(a){this.lossyShown=a;this.graph.clearLabels();this.graph.showLabels()};function PeptideFragmentationKey(a,b,c){this.highlightChanged=new signals.Signal;this.spectrumViewer=b;this.options=c||{};this.margin={top:20,right:20,bottom:40,left:40};this.g=a.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")")}
PeptideFragmentationKey.prototype.setData=function(a,b,c,e,d){function h(a){for(var b=[],c=0;c<a;c++)b.push("#");return b}function f(a,b,c,e){for(var d=a.length,g=0;g<d;g++)"#"!=a[g]&&(e[g]=k.g.append("text").attr("x",20*g).attr("y",b).attr("text-anchor","middle").attr("fill",c).text(a[g]))}function n(a,b,c){for(var e=p.length,d=0;d<e;d++){var h=a[d];if("#"!=h&&"--"!=h){var f=20*d+10;if(-1!=h.indexOf("b")){var l="M"+f+","+(b-20)+" L"+f+","+b+" L"+(f-5)+","+(b+5),m=k.g.append("path").attr("d",l).attr("stroke",
SpectrumViewer.highlightColour).attr("stroke-width",SpectrumViewer.highlightWidth).attr("opacity",0).attr("peptide",c).attr("fragKeyIndex",d),l=m[0][0];l.onmouseover=function(a){g(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))};l.onmouseout=function(a){g()};l.ontouchstart=function(a){g(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))};l.ontouchend=function(a){g()};c===k.spectrumViewer.pep1?k.pep1bFragHighlights[d]=m:k.pep2bFragHighlights[d]=m;l=k.g.append("line").attr("x1",
f).attr("y1",b).attr("x2",f-5).attr("y2",b+5).attr("peptide",c).attr("fragKeyIndex",d).attr("class","fragBar");-1!=h.indexOf("bloss")?l.attr("stroke",SpectrumViewer.lossFragBarColour):l.attr("stroke","black");l=l[0][0];l.onmouseover=function(a){g(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))};l.onmouseout=function(a){g()};l.ontouchstart=function(a){g(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))};l.ontouchend=function(a){g()}}-1!=h.indexOf("y")&&(l="M"+f+","+b+
" L"+f+","+(b-20)+" L"+(f+5)+","+(b-20-5),m=k.g.append("path").attr("d",l).attr("stroke",SpectrumViewer.highlightColour).attr("stroke-width",SpectrumViewer.highlightWidth).attr("opacity",0).attr("peptide",c).attr("fragKeyIndex",d),l=m[0][0],l.onmouseover=function(a){g(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))},l.onmouseout=function(a){g()},l.ontouchstart=function(a){g(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))},l.ontouchend=function(a){g()},c===k.spectrumViewer.pep1?
k.pep1yFragHighlights[d]=m:k.pep2yFragHighlights[d]=m,l=k.g.append("line").attr("x1",f).attr("y1",b-20).attr("x2",f+5).attr("y2",b-20-5).attr("peptide",c).attr("fragKeyIndex",d).attr("class","fragBar"),-1!=h.indexOf("yloss")?l.attr("stroke",SpectrumViewer.lossFragBarColour):l.attr("stroke","black"),l=l[0][0],l.onmouseover=function(a){g(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))},l.onmouseout=function(a){g()},l.ontouchstart=function(a){g(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))},
l.ontouchend=function(a){g()});f=k.g.append("line").attr("x1",f).attr("y1",b).attr("x2",f).attr("y2",b-20).attr("peptide",c).attr("fragKeyIndex",d).attr("class","fragBar");2==(h.match(/loss/g)||[]).length||"-yloss"==h||"bloss-"==h?f.attr("stroke",SpectrumViewer.lossFragBarColour):f.attr("stroke","black");l=f[0][0];l.onmouseover=function(a){g(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))};l.onmouseout=function(a){g()};l.ontouchstart=function(a){g(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))};
l.ontouchend=function(a){g()}}}}function g(a,b){k.clearHighlights();var c;a===k.spectrumViewer.pep1?(k.pep1bFragHighlights[b]&&k.pep1bFragHighlights[b].attr("opacity",1),k.pep1yFragHighlights[b]&&k.pep1yFragHighlights[b].attr("opacity",1),c=b-k.pep1offset):(k.pep2bFragHighlights[b]&&k.pep2bFragHighlights[b].attr("opacity",1),k.pep2yFragHighlights[b]&&k.pep2yFragHighlights[b].attr("opacity",1),c=b-k.pep2offset);k.highlightChanged.dispatch(a,c)}function m(a,b){for(var c=[],d=1;d<b.length+1;d++){var e=
"-",h="-",f="a"+d,g="b"+d,k="c"+d;if(-1!=a.indexOf(f)||-1!=a.indexOf(g)||-1!=a.indexOf(k))e="b";else if(-1!=a.indexOf(f+"loss")||-1!=a.indexOf(g+"loss")||-1!=a.indexOf(k+"loss"))e="bloss";f="x"+(b.length-d);g="y"+(b.length-d);k="z"+(b.length-d);if(-1!=a.indexOf(f)||-1!=a.indexOf(g)||-1!=a.indexOf(k))h="y";else if(-1!=a.indexOf(f+"loss")||-1!=a.indexOf(g+"loss")||-1!=a.indexOf(k+"loss"))h="yloss";c.push(e+h)}return c}var k=this;this.clear();this.pepSeq1=a;this.linkPos1=b;this.pepSeq2=c;this.linkPos2=
e;var p=this.pepSeq1.replace(SpectrumViewer.notUpperCase,"");a=this.pepSeq2.replace(SpectrumViewer.notUpperCase,"");var r=/(.\d*)/g,q=d3.set();c=d3.set();for(var v=d.length,t=0;t<v;t++){var s=d[t];r.lastIndex=0;var u=r.exec(s.fragment_name.trim());""!=s.fragment_name.trim()&&(ion=-1==s.fragment_name.indexOf("_")?u[0]:u[0]+"loss",s.matchedpeptide.replace(SpectrumViewer.notUpperCase,"")==p?q.add(ion):c.add(ion))}q=q.values();c=c.values();console.log(q);console.log(c);d=m(q,p);c=m(c,a);q=b-e;r=h(Math.abs(q));
this.pep2offset=this.pep1offset=0;0>=q?(p=Array(Math.abs(q)+1).join("#")+p,d=r.concat(d),b=e,this.pep1offset=Math.abs(q)-0):(a=Array(q+1).join("#")+a,c=r.concat(c),this.pep2offset=q-0);console.log("linkpos: "+b);e=p.length-a.length;r=h(Math.abs(e));0>=e?(p+=Array(Math.abs(e)+1).join("#"),d=d.concat(r)):(a+=Array(e+1).join("#"),c=c.concat(r));console.log(d);console.log(c);this.pep1letters=[];this.pep2letters=[];f(p,20,SpectrumViewer.p1color,this.pep1letters);f(a,60,SpectrumViewer.p2color,this.pep2letters);
k.g.append("line").attr("x1",20*(b-1)).attr("y1",22).attr("x2",20*(b-1)).attr("y2",42).attr("stroke","black").attr("stroke-width",1.5);n(d,25,k.spectrumViewer.pep1);n(c,65,k.spectrumViewer.pep2)};PeptideFragmentationKey.prototype.clear=function(){this.linkPos2=this.pep2offset=this.pepSeq2=this.linkPos1=this.pep1offset=this.pepSeq1=null;this.pep1bFragHighlights=[];this.pep1yFragHighlights=[];this.pep2bFragHighlights=[];this.pep2yFragHighlights=[];this.g.selectAll("*").remove()};
PeptideFragmentationKey.prototype.setHighlights=function(a){function b(a){for(var b=a.length,c=0;c<b;c++)a[c]&&a[c].attr("fill",SpectrumViewer.lossFragBarColour)}function c(a,b,c,d){for(;c<d;c++)a[c]&&a[c].attr("fill",b)}this.clearHighlights();var e=a.length;if(0<e){b(this.pep1letters);b(this.pep2letters);for(var d=0;d<e;d++){var h=a[d];if(!0===this.spectrumViewer.lossyShown||!1===h.lossy){var f,n,g,m,k;this.spectrumViewer.pep1==h.peptide?(f="pep1",n=this.pep1offset,g=this.pepSeq1.length,m=this.pep1letters,
k=SpectrumViewer.p1color):(f="pep2",n=this.pep2offset,g=this.pepSeq2.length,m=this.pep2letters,k=SpectrumViewer.p2color);var p=h.ionType;f+=p+"FragHighlights";"b"==p?(this[f][h.ionNumber+n-1].attr("opacity",1),c(m,k,0,h.ionNumber+n)):(this[f][g-h.ionNumber+n-1].attr("opacity",1),c(m,k,g-h.ionNumber+n,m.length))}}}};
PeptideFragmentationKey.prototype.clearHighlights=function(){function a(a){for(var b=a.length,d=0;d<b;d++)a[d]&&a[d].attr("opacity",0)}function b(a,b){for(var d=a.length,h=0;h<d;h++)a[h]&&a[h].attr("fill",b)}a(this.pep1bFragHighlights);a(this.pep1yFragHighlights);a(this.pep2bFragHighlights);a(this.pep2yFragHighlights);b(this.pep1letters,SpectrumViewer.p1color);b(this.pep2letters,SpectrumViewer.p2color)};Graph=function(a,b,c){this.x=d3.scale.linear();this.y=d3.scale.linear();this.highlightChanged=new signals.Signal;this.spectrumViewer=b;this.margin={top:c.title?130:110,right:10,bottom:c.xlabel?50:20,left:c.ylabel?60:30};this.g=a.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")");this.xaxis=this.g.append("g").attr("class","x axis");this.brush=d3.svg.brush().x(this.x).on("brushstart",function(){e.dragZoomHighlight.attr("width",0);e.dragZoomHighlight.attr("display","inline")}).on("brush",
function(){var a=e.brush.extent(),b=e.x(a[1]-a[0])-e.x(0);e.dragZoomHighlight.attr("x",e.x(a[0])).attr("width",b)}).on("brushend",function(){e.dragZoomHighlight.attr("display","none");var a=e.brush.extent();e.x.domain(a);e.brush.x(e.x);e.redraw()()});this.xaxisRect=this.g.append("rect").attr("height","25").attr("opacity",0).attr("pointer-events","all").style("cursor","crosshair");this.xaxisRect.call(this.brush);this.yaxis=this.g.append("g").attr("class","y axis");this.plot=this.g.append("rect").style("fill",
"white").attr("pointer-events","all");this.innerSVG=this.g.append("g").attr("top",0).attr("left",0).attr("class","line");this.dragZoomHighlight=this.innerSVG.append("rect").attr("y",0).attr("fill","#addd8e");this.highlights=this.innerSVG.append("g");this.peaks=this.innerSVG.append("g");this.lossyAnnotations=this.innerSVG.append("g");this.annotations=this.innerSVG.append("g");c.title&&(this.title=this.g.append("text").attr("class","axis").text(c.title).attr("dy","-0.8em").style("text-anchor","middle"));
c.xlabel&&(this.xlabel=this.g.append("text").attr("class","aWWWAAAAAxis").text(c.xlabel).attr("dy","2.4em").style("text-anchor","middle").style("pointer-events","none"));c.ylabel&&(this.ylabel=this.g.append("g").append("text").attr("class","axis").text(c.ylabel).style("text-anchor","middle").style("pointer-events","none"));var e=this};
Graph.prototype.setData=function(a){this.clear();this.xmaxPrimary=d3.max(a,function(a){return 1==a.isprimarymatch?a.expmz-0:0})+50;this.xminPrimary=d3.min(a,function(a){return 1==a.isprimarymatch?a.expmz-0:this.xmaxPrimary})-50;a=d3.nest().key(function(a){return a.expmz+"-"+a.absoluteintensity}).entries(a);this.points=[];for(var b=0;b<a.length;b++)this.points.push(new Peak(a[b].values,this));this.xmax=this.xmaxPrimary;this.xmin=this.xminPrimary;this.ymax=d3.max(this.points,function(a){return a.y});
this.ymin=0;this.resize()};
Graph.prototype.resize=function(){var a=this.g.node().parentNode.parentNode.clientWidth,b=this.g.node().parentNode.parentNode.clientHeight;this.g.attr("width",a).attr("height",b);a=a-this.margin.left-this.margin.right;b=b-this.margin.top-this.margin.bottom;this.x.domain([this.xmin,this.xmax]).range([0,a]);this.y.domain([0,this.ymax]).nice().range([b,0]).nice();var c=b/40,e=a/100;this.yaxis.call(d3.svg.axis().scale(this.y).ticks(c).orient("left").tickFormat(d3.format("s")));this.xAxis=d3.svg.axis().scale(this.x).ticks(e).orient("bottom");
this.xaxis.attr("transform","translate(0,"+b+")").call(this.xAxis);this.g.selectAll(".axis line, .axis path").style({stroke:"Black",fill:"none","stroke-width":"1.2px"});this.plot.attr("width",a).attr("height",b);this.innerSVG.attr("width",a).attr("height",b).attr("viewBox","0 0 "+a+" "+b);this.xaxisRect.attr("width",a).attr("y",b).attr("height",this.margin.bottom);this.dragZoomHighlight.attr("height",b);this.zoom=d3.behavior.zoom().x(this.x).on("zoom",this.redraw());this.plot.call(d3.behavior.zoom().x(this.x).on("zoom",
this.redraw()));this.innerSVG.call(this.zoom);this.title&&this.title.attr("x",a/2);this.xlabel.attr("x",a/2).attr("y",b);this.ylabel.attr("transform","translate(-45 "+b/2+") rotate(-90)");this.redraw()()};Graph.prototype.redraw=function(){var a=this;return function(){for(var b=0;b<a.points.length;b++)a.points[b].update();a.xaxis.call(a.xAxis);a.plot.call(d3.behavior.zoom().x(a.x).on("zoom",a.redraw()));a.innerSVG.call(d3.behavior.zoom().x(a.x).on("zoom",a.redraw()))}};
Graph.prototype.clear=function(){this.points=[];this.highlights.selectAll("*").remove();this.peaks.selectAll("*").remove();this.lossyAnnotations.selectAll("*").remove();this.annotations.selectAll("*").remove()};
Graph.prototype.setHighlights=function(a,b){this.clearHighlights();if(a){this.clearLabels();this.greyPeaks();for(var c=this.points.length,e=0;e<c;e++){for(var d=!1,h=this.points[e],f=h.fragments.length,n=0;n<f;n++){var g=h.fragments[n],m=g.peptide;a==g.peptide&&("y"==g.ionType&&g.ionNumber==m.length-b-1||"b"==g.ionType&&g.ionNumber==b-0+1)&&(d=!0)}!0===d&&(this.points[e].highlight(!0),this.points[e].showLabels())}}else this.showLabels(),this.colourPeaks()};
Graph.prototype.clearHighlights=function(a,b){for(var c=this.points.length,e=0;e<c;e++)0<this.points[e].fragments.length&&this.points[e].highlight(!1)};Graph.prototype.clearLabels=function(){for(var a=this.points.length,b=0;b<a;b++)0<this.points[b].fragments.length&&this.points[b].removeLabels()};Graph.prototype.showLabels=function(){for(var a=this.points.length,b=0;b<a;b++)0<this.points[b].fragments.length&&this.points[b].showLabels()};
Graph.prototype.greyPeaks=function(){for(var a=this.points.length,b=0;b<a;b++)this.points[b].line.attr("stroke",SpectrumViewer.lossFragBarColour)};Graph.prototype.colourPeaks=function(){for(var a=this.points.length,b=0;b<a;b++){var c=this.points[b];c.line.attr("stroke",c.colour)}};function Peak(a,b){this.x=a[0].expmz-0;this.y=a[0].absolute_intensity-0;this.graph=b;for(var c=[],e=[],d=a.length,h=0;h<d;h++)if(""!=a[h].fragment_name.trim()){var f=new Fragment(a[h]);!1===f.lossy?c.push(f):e.push(f)}this.fragments=c.concat(e);f="";d=this.fragments.length;for(h=0;h<d;h++)0<h&&(f+=", "),f+=this.fragments[h].sequence;this.tooltip=f+" m/z: "+this.x+", i: "+this.y;this.g=this.graph.peaks.append("g");this.g.append("svg:title").text(this.tooltip);if(0<this.fragments.length){var n=function(){m.highlight(!1);
m.graph.highlightChanged.dispatch([]);m.graph.colourPeaks();m.graph.showLabels()},g=function(){m.graph.greyPeaks();m.graph.clearLabels();m.highlight(!0);m.graph.highlightChanged.dispatch(m.fragments)};this.highlightLine=this.g.append("line").attr("stroke",SpectrumViewer.highlightColour).attr("stroke-width",SpectrumViewer.highlightWidth).attr("opacity","0");this.highlightLine.attr("x1",0);this.highlightLine.attr("x2",0);var m=this,d=this.g[0][0];d.onmouseover=function(a){g()};d.onmouseout=function(a){n()};
d.ontouchstart=function(a){g()};d.ontouchend=function(a){n()};this.labels=[];this.labelHighlights=[];d=this.fragments.length;for(h=0;h<d;h++){f=this.fragments[h];!1===f.lossy?(c=this.graph.annotations.append("text"),e=this.graph.annotations.append("text")):(c=this.graph.lossyAnnotations.append("text"),e=this.graph.lossyAnnotations.append("text"));c.text(f.name).attr("x",0).attr("text-anchor","middle").style("stroke-width","5px").attr("stroke",SpectrumViewer.highlightColour);e.text(f.name).attr("x",
0).attr("text-anchor","middle").attr("class","peakAnnot");var k="pink",k=this.graph.spectrumViewer.pep1==f.peptide?"p1":"p2",k=-1==f.name.indexOf("_")?SpectrumViewer[k+"color"]:SpectrumViewer[k+"color_loss"];e.attr("fill",k);this.labels.push(e);this.labelHighlights.push(c)}this.highlight(!1)}this.line=this.g.append("line").attr("stroke-width","1");this.line.attr("x1",0);this.line.attr("x2",0);this.colour=SpectrumViewer.lossFragBarColour;0<this.fragments.length&&(this.fragments[0].peptide===this.graph.spectrumViewer.pep1&&
!1===this.fragments[0].lossy?this.colour=SpectrumViewer.p1color:this.fragments[0].peptide===this.graph.spectrumViewer.pep2&&!1===this.fragments[0].lossy?this.colour=SpectrumViewer.p2color:this.fragments[0].peptide===this.graph.spectrumViewer.pep1&&!0===this.fragments[0].lossy?this.colour=SpectrumViewer.p1color_loss:this.fragments[0].peptide===this.graph.spectrumViewer.pep2&&!0===this.fragments[0].lossy&&(this.colour=SpectrumViewer.p2color_loss));this.line.attr("stroke",this.colour);this.removeLabels();
this.showLabels()}Peak.prototype.highlight=function(a){var b=this.labels.length;if(1==a){this.highlightLine.attr("opacity","1");for(a=0;a<b;a++)this.labelHighlights[a].attr("opacity",1);this.graph.peaks[0][0].appendChild(this.g[0][0]);this.line.attr("stroke",this.colour);this.showLabels()}else for(this.highlightLine.attr("opacity",0),a=0;a<b;a++)this.labelHighlights[a].attr("opacity",0)};Peak.prototype.update=function(){this.updateX();this.updateY()};
Peak.prototype.updateX=function(){this.g.attr("transform","translate("+this.graph.x(this.x)+",0)");if(0<this.fragments.length)for(var a=this.labels.length,b=0;b<a;b++)this.labels[b].attr("x",this.graph.x(this.x)),this.labelHighlights[b].attr("x",this.graph.x(this.x));a=this.graph.x.domain();this.x>a[0]&&this.x<a[1]?this.g.attr("display","inline"):this.g.attr("display","none")};
Peak.prototype.updateY=function(){this.line.attr("y1",this.graph.y(this.y));this.line.attr("y2",this.graph.y(0));if(0<this.fragments.length){this.highlightLine.attr("y1",this.graph.y(this.y));this.highlightLine.attr("y2",this.graph.y(0));for(var a=this.labels.length,b=0;b<a;b++)this.labels[b].attr("y",this.graph.y(this.y)-5-15*b),this.labelHighlights[b].attr("y",this.graph.y(this.y)-5-15*b)}};
Peak.prototype.removeLabels=function(){if(0<this.fragments.length)for(var a=this.labels.length,b=0;b<a;b++)this.labels[b].attr("display","none"),this.labelHighlights[b].attr("display","none")};Peak.prototype.showLabels=function(){if(0<this.fragments.length)for(var a=this.labels.length,b=0;b<a;b++)if(!0===this.graph.spectrumViewer.lossyShown||!1===this.fragments[b].lossy)this.labels[b].attr("display","inline"),this.labelHighlights[b].attr("display","inline")};function Fragment(a){this.name=a.fragment_name.trim();this.peptide=a.matchedpeptide.replace(SpectrumViewer.notUpperCase,"");this.sequence=a.sequence;a=this.name.split("")[0];this.ionType="a"==a||"b"==a||"c"==a?"b":"y";this.ionNumber=/(.(\d*))/g.exec(this.name)[2]-0;this.lossy=!1;-1!=this.name.indexOf("_")&&(this.lossy=!0)};
