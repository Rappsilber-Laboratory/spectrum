registerKeyboardHandler=function(a){d3.select(window).on("keydown",a)};
Graph=function(a,b){this.chart=document.getElementById(a);this.cx=this.chart.clientWidth;this.cy=this.chart.clientHeight;this.options=b||{};var d=d3.nest().key(function(a){return a.expmz+"-"+a.absoluteintensity}).entries(this.options.identData);this.points=[];for(var c=0;c<d.length;c++)this.points.push(new Peak(d[c].values,this));this.options.xmax=d3.max(this.points,function(a){return a.x})+100;this.options.xmin=d3.min(this.points,function(a){return a.x})-100;this.options.ymax=d3.max(this.points,
function(a){return a.y});this.options.ymin=d3.min(this.points,function(a){return a.y});this.padding={top:this.options.title?40:20,right:30,bottom:this.options.xlabel?60:10,left:this.options.ylabel?120:45};this.size={width:this.cx-this.padding.left-this.padding.right,height:this.cy-this.padding.top-this.padding.bottom};this.x=d3.scale.linear().domain([this.options.xmin,this.options.xmax]).range([0,this.size.width]);this.downx=Math.NaN;this.y=d3.scale.linear().domain([this.options.ymax,this.options.ymin]).nice().range([0,
this.size.height]).nice();this.downy=Math.NaN;this.dragged=this.selected=null;this.line=d3.svg.line().x(function(a,b){return this.x(this.points[b].x)}).y(function(a,b){return this.y(this.points[b].y)});this.vis=d3.select(this.chart).append("svg").attr("width",this.cx).attr("height",this.cy).append("g").attr("transform","translate("+this.padding.left+","+this.padding.top+")");this.plot=this.vis.append("rect").attr("width",this.size.width).attr("height",this.size.height).style("fill","#EEEEEE").attr("pointer-events",
"all").on("mousedown.drag",this.plot_drag()).on("touchstart.drag",this.plot_drag());this.plot.call(d3.behavior.zoom().x(this.x).y(this.y).on("zoom",this.redraw()));this.innerSVG=this.vis.append("svg").attr("top",0).attr("left",0).attr("width",this.size.width).attr("height",this.size.height).attr("viewBox","0 0 "+this.size.width+" "+this.size.height).attr("class","line");this.annotations=this.innerSVG.append("g");this.peaks=this.innerSVG.append("g");this.options.title&&(this.title=this.vis.append("text").attr("class",
"axis").text(this.options.title).attr("x",this.size.width/2).attr("dy","-0.8em").style("text-anchor","middle"));this.options.xlabel&&this.vis.append("text").attr("class","axis").text(this.options.xlabel).attr("x",this.size.width/2).attr("y",this.size.height).attr("dy","2.4em").style("text-anchor","middle");this.options.ylabel&&this.vis.append("g").append("text").attr("class","axis").text(this.options.ylabel).style("text-anchor","middle").attr("transform","translate(-90 "+this.size.height/2+") rotate(-90)");
for(c=0;c<this.points.length;c++)this.points[c].init();console.log(Annotation.colours.domain());this.redraw()()};Graph.prototype.plot_drag=function(){};Graph.prototype.update=function(){for(var a=0;a<this.points.length;a++)this.points[a].update();d3.event&&d3.event.keyCode&&(d3.event.preventDefault(),d3.event.stopPropagation())};
Graph.prototype.datapoint_drag=function(){var a=this;return function(b){registerKeyboardHandler(a.keydown());document.onselectstart=function(){return!1};a.selected=a.dragged=b;a.update()}};
Graph.prototype.redraw=function(){var a=this;return function(){var b=function(b){return"translate("+a.x(b)+",0)"},d=function(b){return"translate(0,"+a.y(b)+")"},c=function(a){return a?"#ccc":"#666"},e=a.x.tickFormat(10),g=a.y.tickFormat(10),f=a.vis.selectAll("g.x").data(a.x.ticks(10),String).attr("transform",b);f.select("text").text(e);b=f.enter().insert("g","a").attr("class","x").attr("transform",b);b.append("line").attr("stroke",c).attr("y1",0).attr("y2",a.size.height);b.append("text").attr("class",
"axis").attr("y",a.size.height).attr("dy","1em").attr("text-anchor","middle").text(e).style("cursor","ew-resize").on("mouseover",function(a){d3.select(this).style("font-weight","bold")}).on("mouseout",function(a){d3.select(this).style("font-weight","normal")}).on("mousedown.drag",a.xaxis_drag()).on("touchstart.drag",a.xaxis_drag());f.exit().remove();e=a.vis.selectAll("g.y").data(a.y.ticks(10),String).attr("transform",d);e.select("text").text(g);d=e.enter().insert("g","a").attr("class","y").attr("transform",
d).attr("background-fill","#FFEEB6");d.append("line").attr("stroke",c).attr("x1",0).attr("x2",a.size.width);d.append("text").attr("class","axis").attr("x",-3).attr("dy",".35em").attr("text-anchor","end").text(g).style("cursor","ns-resize").on("mouseover",function(a){d3.select(this).style("font-weight","bold")}).on("mouseout",function(a){d3.select(this).style("font-weight","normal")}).on("mousedown.drag",a.yaxis_drag()).on("touchstart.drag",a.yaxis_drag());e.exit().remove();a.plot.call(d3.behavior.zoom().x(a.x).y(a.y).on("zoom",
a.redraw()));a.update()}};Graph.prototype.xaxis_drag=function(){};Graph.prototype.yaxis_drag=function(a){};Graph.prototype.setTitle=function(a){this.title.text(a)};function Peak(a,b){this.x=a[0].expmz-0;this.y=a[0].absoluteintesity-0;this.graph=b;this.annotation=new Annotation(a,b)}Peak.prototype.init=function(){this.line=this.graph.peaks.append("line");this.line.attr("stroke","black");this.line.attr("stroke-width","1");this.annotation.init()};Peak.prototype.update=function(){this.line.attr("x1",this.graph.x(this.x));this.line.attr("y1",this.graph.y(this.y));this.line.attr("x2",this.graph.x(this.x));this.line.attr("y2",this.graph.y(0));this.annotation.update()};function Annotation(a,b){this.x=a[0].expmz-0;this.y=a[0].absoluteintesity-0;this.graph=b;this.sequences=this.fragmentNames="";this.primary=!1;for(var d=0;d<a.length;d++){var c=a[d];1==c.isprimarymatch&&(this.primary=!0);0<d&&(this.fragmentNames+=" & ",this.sequences+=" & ");this.fragmentNames+=c.fragment_name;this.sequences+=c.sequence}}Annotation.colours=d3.scale.ordinal().range(colorbrewer.Set2[3]);
Annotation.prototype.init=function(){var a=this;if(this.primary){this.circle=this.graph.annotations.append("circle");this.circle.attr("r",15);var b="";-1!==this.fragmentNames.indexOf("b")&&(b+="b");-1!==this.fragmentNames.indexOf("y")&&(b+="y");this.circle.attr("fill",Annotation.colours(b));this.circle.append("svg:title").text(this.fragmentNames);this.circle.on("click",function(){a.graph.setTitle(a.sequences)})}};
Annotation.prototype.update=function(){this.primary&&(this.circle.attr("cx",this.graph.x(this.x)),this.circle.attr("cy",this.graph.y(this.y)))};
