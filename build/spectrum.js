function SpectrumViewer(a){"string"===typeof a&&(a=document.getElementById(a));d3.select(a).selectAll("*").remove();this.svg=d3.select(a).append("svg").style("width","100%").style("height","100%");this.peptideFragKey=new PeptideFragmentationKey(this.svg,this);this.graph=new Graph(this.svg,this,{xlabel:"m/z",ylabel:"intensity"});this.peptideFragKey.highlightChanged.add(this.graph.setHighlights).context=this.graph;this.graph.highlightChanged.add(this.peptideFragKey.setHighlights).context=this.peptideFragKey}
SpectrumViewer.cmap=colorbrewer.Paired[6];SpectrumViewer.p1color=SpectrumViewer.cmap[5];SpectrumViewer.p1color_loss=SpectrumViewer.cmap[4];SpectrumViewer.p2color=SpectrumViewer.cmap[1];SpectrumViewer.p2color_loss=SpectrumViewer.cmap[0];SpectrumViewer.lossFragBarColour="#cccccc";SpectrumViewer.highlightColour="yellow";SpectrumViewer.highlightWidth=11;SpectrumViewer.notUpperCase=/[^A-Z]/g;
SpectrumViewer.prototype.setData=function(a,b,d,c,e){this.pep1=a.replace(SpectrumViewer.notUpperCase,"");this.pep2=d.replace(SpectrumViewer.notUpperCase,"");this.annotatedPeaks=d3.csv.parse(e.trim());this.linkPos1=b;this.linkPos2=c;this.lossyShown=!1;this.peptideFragKey.setData(this.pep1,this.linkPos1,this.pep2,this.linkPos2,this.annotatedPeaks);this.graph.setData(this.annotatedPeaks)};SpectrumViewer.prototype.clear=function(){this.pep2=this.pep1="";this.peptideFragKey.clear();this.graph.clear()};
SpectrumViewer.prototype.resize=function(){this.graph.resize()};SpectrumViewer.prototype.getSVG=function(){var a=this.svg[0][0].parentNode.innerHTML,a=a.replace("<svg ",'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:ev="http://www.w3.org/2001/xml-events" ');return'<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+a};
SpectrumViewer.prototype.showLossy=function(a){this.lossyShown=a;this.graph.clearLabels();this.graph.showLabels()};function PeptideFragmentationKey(a,b,d){this.highlightChanged=new signals.Signal;this.spectrumViewer=b;this.options=d||{};this.margin={top:this.options.title?40:20,right:20,bottom:this.options.xlabel?60:40,left:this.options.ylabel?100:80};this.g=a.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")")}
PeptideFragmentationKey.prototype.setData=function(a,b,d,c,e){function k(a){for(var b=[],d=0;d<a;d++)b.push("#");return b}function l(a,b,d){for(var c=a.length,e=0;e<c;e++)"#"!=a[e]&&g.g.append("text").attr("x",20*e).attr("y",b).attr("text-anchor","middle").attr("fill",d).text(a[e])}function p(a,b,d){for(var c=q.length,e=0;e<c;e++){var k=a[e];if("#"!=k&&"--"!=k){var m=20*e+10;if(-1!=k.indexOf("b")){var f="M"+m+","+(b-20)+" L"+m+","+b+" L"+(m-5)+","+(b+5),l=g.g.append("path").attr("d",f).attr("stroke",
SpectrumViewer.highlightColour).attr("stroke-width",SpectrumViewer.highlightWidth).attr("opacity",0).attr("peptide",d).attr("fragKeyIndex",e),f=l[0][0];f.onmouseover=function(a){h(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))};f.onmouseout=function(a){h()};f.ontouchstart=function(a){h(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))};f.ontouchend=function(a){h()};d===g.spectrumViewer.pep1?g.pep1bFragHighlights[e]=l:g.pep2bFragHighlights[e]=l;f=g.g.append("line").attr("x1",
m).attr("y1",b).attr("x2",m-5).attr("y2",b+5).attr("peptide",d).attr("fragKeyIndex",e).attr("class","fragBar");-1!=k.indexOf("bloss")?f.attr("stroke",SpectrumViewer.lossFragBarColour):f.attr("stroke","black");f=f[0][0];f.onmouseover=function(a){h(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))};f.onmouseout=function(a){h()};f.ontouchstart=function(a){h(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))};f.ontouchend=function(a){h()}}-1!=k.indexOf("y")&&(f="M"+m+","+b+
" L"+m+","+(b-20)+" L"+(m+5)+","+(b-20-5),l=g.g.append("path").attr("d",f).attr("stroke",SpectrumViewer.highlightColour).attr("stroke-width",SpectrumViewer.highlightWidth).attr("opacity",0).attr("peptide",d).attr("fragKeyIndex",e),f=l[0][0],f.onmouseover=function(a){h(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))},f.onmouseout=function(a){h()},f.ontouchstart=function(a){h(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))},f.ontouchend=function(a){h()},d===g.spectrumViewer.pep1?
g.pep1yFragHighlights[e]=l:g.pep2yFragHighlights[e]=l,f=g.g.append("line").attr("x1",m).attr("y1",b-20).attr("x2",m+5).attr("y2",b-20-5).attr("peptide",d).attr("fragKeyIndex",e).attr("class","fragBar"),-1!=k.indexOf("yloss")?f.attr("stroke",SpectrumViewer.lossFragBarColour):f.attr("stroke","black"),f=f[0][0],f.onmouseover=function(a){h(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))},f.onmouseout=function(a){h()},f.ontouchstart=function(a){h(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))},
f.ontouchend=function(a){h()});m=g.g.append("line").attr("x1",m).attr("y1",b).attr("x2",m).attr("y2",b-20).attr("peptide",d).attr("fragKeyIndex",e).attr("class","fragBar");2==(k.match(/loss/g)||[]).length||"-yloss"==k||"bloss-"==k?m.attr("stroke",SpectrumViewer.lossFragBarColour):m.attr("stroke","black");f=m[0][0];f.onmouseover=function(a){h(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))};f.onmouseout=function(a){h()};f.ontouchstart=function(a){h(this.getAttribute("peptide"),this.getAttribute("fragKeyIndex"))};
f.ontouchend=function(a){h()}}}}function h(a,b){g.clearHighlights();var d;a===g.spectrumViewer.pep1?(g.pep1bFragHighlights[b]&&g.pep1bFragHighlights[b].attr("opacity",1),g.pep1yFragHighlights[b]&&g.pep1yFragHighlights[b].attr("opacity",1),d=b-g.pep1offset):(g.pep2bFragHighlights[b]&&g.pep2bFragHighlights[b].attr("opacity",1),g.pep2yFragHighlights[b]&&g.pep2yFragHighlights[b].attr("opacity",1),d=b-g.pep2offset);g.highlightChanged.dispatch(a,d)}function s(a,b){for(var d=[],c=1;c<b.length+1;c++){var e=
"-",k="-",g="a"+c,f="b"+c,h="c"+c;if(-1!=a.indexOf(g)||-1!=a.indexOf(f)||-1!=a.indexOf(h))e="b";else if(-1!=a.indexOf(g+"loss")||-1!=a.indexOf(f+"loss")||-1!=a.indexOf(h+"loss"))e="bloss";g="x"+(b.length-c);f="y"+(b.length-c);h="z"+(b.length-c);if(-1!=a.indexOf(g)||-1!=a.indexOf(f)||-1!=a.indexOf(h))k="y";else if(-1!=a.indexOf(g+"loss")||-1!=a.indexOf(f+"loss")||-1!=a.indexOf(h+"loss"))k="yloss";d.push(e+k)}return d}var g=this;this.clear();this.pepSeq1=a;this.linkPos1=b;this.pepSeq2=d;this.linkPos2=
c;var q=this.pepSeq1.replace(SpectrumViewer.notUpperCase,"");a=this.pepSeq2.replace(SpectrumViewer.notUpperCase,"");var r=/(.\d*)/g,n=d3.set();d=d3.set();for(var w=e.length,u=0;u<w;u++){var t=e[u];r.lastIndex=0;var v=r.exec(t.fragment_name.trim());""!=t.fragment_name.trim()&&(ion=-1==t.fragment_name.indexOf("_")?v[0]:v[0]+"loss",t.matchedpeptide.replace(SpectrumViewer.notUpperCase,"")==q?n.add(ion):d.add(ion))}n=n.values();d=d.values();console.log(n);console.log(d);e=s(n,q);d=s(d,a);n=b-c;r=k(Math.abs(n));
this.pep2offset=this.pep1offset=0;0>=n?(q=Array(Math.abs(n)+1).join("#")+q,e=r.concat(e),b=c,this.pep1offset=Math.abs(n)-0):(a=Array(n+1).join("#")+a,d=r.concat(d),this.pep2offset=n-0);console.log("linkpos: "+b);c=q.length-a.length;r=k(Math.abs(c));0>=c?(q+=Array(Math.abs(c)+1).join("#"),e=e.concat(r)):(a+=Array(c+1).join("#"),d=d.concat(r));console.log(e);console.log(d);l(q,20,SpectrumViewer.p1color);l(a,60,SpectrumViewer.p2color);g.g.append("line").attr("x1",20*(b-1)).attr("y1",22).attr("x2",20*
(b-1)).attr("y2",42).attr("stroke","black").attr("stroke-width",1.5);p(e,25,g.spectrumViewer.pep1);p(d,65,g.spectrumViewer.pep2)};PeptideFragmentationKey.prototype.clear=function(){this.linkPos2=this.pep2offset=this.pepSeq2=this.linkPos1=this.pep1offset=this.pepSeq1=null;this.pep1bFragHighlights=[];this.pep1yFragHighlights=[];this.pep2bFragHighlights=[];this.pep2yFragHighlights=[];this.g.selectAll("*").remove()};
PeptideFragmentationKey.prototype.setHighlights=function(a){this.clearHighlights();for(var b=a.length,d=0;d<b;d++){var c=a[d],e,k,l;this.spectrumViewer.pep1==c.peptide?(e="pep1",k=this.pep1offset,l=this.pepSeq1.length):(e="pep2",k=this.pep2offset,l=this.pepSeq2.length);var p=c.ionType;e+=p+"FragHighlights";"b"==p?this[e][c.ionNumber+k-1].attr("opacity",1):this[e][l-c.ionNumber+k-1].attr("opacity",1)}};
PeptideFragmentationKey.prototype.clearHighlights=function(){function a(a){for(var d=a.length,c=0;c<d;c++)a[c]&&a[c].attr("opacity",0)}a(this.pep1bFragHighlights);a(this.pep1yFragHighlights);a(this.pep2bFragHighlights);a(this.pep2yFragHighlights)};Graph=function(a,b,d){this.x=d3.scale.linear();this.y=d3.scale.linear();this.highlightChanged=new signals.Signal;this.spectrumViewer=b;this.margin={top:d.title?130:110,right:10,bottom:d.xlabel?40:20,left:d.ylabel?100:80};this.g=a.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")");this.xaxis=this.g.append("g").attr("class","x axis");this.brush=d3.svg.brush().x(this.x).on("brushstart",function(){c.dragZoomHighlight.attr("width",0);c.dragZoomHighlight.attr("display",
"inline")}).on("brush",function(){var a=c.brush.extent(),b=c.x(a[1]-a[0])-c.x(0);c.dragZoomHighlight.attr("x",c.x(a[0])).attr("width",b)}).on("brushend",function(){c.dragZoomHighlight.attr("display","none");var a=c.brush.extent();c.x.domain(a);c.brush.x(c.x);c.redraw()()});this.xaxisRect=this.g.append("rect").attr("height","25").attr("opacity",0).attr("pointer-events","all");this.xaxisRect.call(this.brush);this.yaxis=this.g.append("g").attr("class","y axis");this.plot=this.g.append("rect").style("fill",
"white").attr("pointer-events","all");this.innerSVG=this.g.append("g").attr("top",0).attr("left",0).attr("class","line");this.dragZoomHighlight=this.innerSVG.append("rect").attr("y",0).attr("fill","#addd8e");this.highlights=this.innerSVG.append("g");this.peaks=this.innerSVG.append("g");this.lossiAnnotations=this.innerSVG.append("g");this.annotations=this.innerSVG.append("g");d.title&&(this.title=this.g.append("text").attr("class","axis").text(d.title).attr("dy","-0.8em").style("text-anchor","middle"));
d.xlabel&&(this.xlabel=this.g.append("text").attr("class","aWWWAAAAAxis").text(d.xlabel).attr("dy","2.4em").style("text-anchor","middle"));d.ylabel&&(this.ylabel=this.g.append("g").append("text").attr("class","axis").text(d.ylabel).style("text-anchor","middle"));var c=this};
Graph.prototype.setData=function(a){this.clear();this.xmaxPrimary=d3.max(a,function(a){return 1==a.isprimarymatch?a.expmz-0:0})+50;this.xminPrimary=d3.min(a,function(a){return 1==a.isprimarymatch?a.expmz-0:this.xmaxPrimary})-50;a=d3.nest().key(function(a){return a.expmz+"-"+a.absoluteintensity}).entries(a);this.points=[];for(var b=0;b<a.length;b++)this.points.push(new Peak(a[b].values,this));this.xmax=this.xmaxPrimary;this.xmin=this.xminPrimary;this.ymax=d3.max(this.points,function(a){return a.y});
for(b=this.ymin=0;b<this.points.length;b++)this.points[b].init();this.resize()};
Graph.prototype.resize=function(){var a=this.g.node().parentNode.parentNode.clientWidth,b=this.g.node().parentNode.parentNode.clientHeight;this.g.attr("width",a).attr("height",b);a=a-this.margin.left-this.margin.right;b=b-this.margin.top-this.margin.bottom;this.x.domain([this.xmin,this.xmax]).range([0,a]);this.y.domain([0,this.ymax]).nice().range([b,0]).nice();var d=b/40,c=a/100;this.yaxis.call(d3.svg.axis().scale(this.y).ticks(d).orient("left"));this.xAxis=d3.svg.axis().scale(this.x).ticks(c).orient("bottom");
this.xaxis.attr("transform","translate(0,"+b+")").call(this.xAxis);this.g.selectAll(".axis line, .axis path").style({stroke:"Black",fill:"none","stroke-width":"1.2px"});this.plot.attr("width",a).attr("height",b);this.innerSVG.attr("width",a).attr("height",b).attr("viewBox","0 0 "+a+" "+b);this.xaxisRect.attr("width",a).attr("y",b).attr("height",25);this.dragZoomHighlight.attr("height",b);this.zoom=d3.behavior.zoom().x(this.x).on("zoom",this.redraw());this.plot.call(d3.behavior.zoom().x(this.x).on("zoom",
this.redraw()));this.innerSVG.call(this.zoom);this.title&&this.title.attr("x",a/2);this.xlabel.attr("x",a/2).attr("y",b);this.ylabel.attr("transform","translate(-80 "+b/2+") rotate(-90)");this.redraw()()};Graph.prototype.redraw=function(){var a=this;return function(){for(var b=0;b<a.points.length;b++)a.points[b].update();a.xaxis.call(a.xAxis);a.plot.call(d3.behavior.zoom().x(a.x).on("zoom",a.redraw()));a.innerSVG.call(d3.behavior.zoom().x(a.x).on("zoom",a.redraw()))}};
Graph.prototype.clear=function(){this.points=[];this.highlights.selectAll("*").remove();this.peaks.selectAll("*").remove();this.lossiAnnotations.selectAll("*").remove();this.annotations.selectAll("*").remove()};
Graph.prototype.setHighlights=function(a,b){this.clearHighlights();this.clearLabels();if(a)for(var d=this.points.length,c=0;c<d;c++){for(var e=!1,k=this.points[c],l=k.fragments.length,p=0;p<l;p++){var h=k.fragments[p],s=h.peptide;a==h.peptide&&("y"==h.ionType&&h.ionNumber==s.length-b-1||"b"==h.ionType&&h.ionNumber==b-0+1)&&(e=!0)}!0===e&&(this.points[c].highlight(!0),this.points[c].showLabels())}else this.showLabels()};
Graph.prototype.clearHighlights=function(a,b){for(var d=this.points.length,c=0;c<d;c++)0<this.points[c].fragments.length&&this.points[c].highlight(!1)};Graph.prototype.clearLabels=function(){for(var a=this.points.length,b=0;b<a;b++)0<this.points[b].fragments.length&&this.points[b].removeLabels()};Graph.prototype.showLabels=function(){for(var a=this.points.length,b=0;b<a;b++)0<this.points[b].fragments.length&&this.points[b].showLabels()};function Peak(a,b){this.x=a[0].expmz-0;this.y=a[0].absolute_intensity-0;this.graph=b;this.notLossyFragments=[];this.lossyFragments=[];for(var d=a.length,c=0;c<d;c++)if(""!=a[c].fragment_name.trim()){var e=new Fragment(a[c]);!1===e.lossy?this.notLossyFragments.push(e):this.lossyFragments.push(e)}this.fragments=this.notLossyFragments.concat(this.lossyFragments);e="";d=this.fragments.length;for(c=0;c<d;c++)0<c&&(e+=", "),e+=this.fragments[c].sequence;this.tooltip=e+" m/z: "+this.x+", i: "+this.y}
Peak.prototype.init=function(){this.line=this.graph.peaks.append("line").attr("stroke-width","1");this.line.append("svg:title").text(this.tooltip);if(0<this.fragments.length){this.fragments[0].peptide===this.graph.spectrumViewer.pep1&&!1===this.fragments[0].lossy?this.line.attr("stroke",SpectrumViewer.p1color):this.fragments[0].peptide===this.graph.spectrumViewer.pep2&&!1===this.fragments[0].lossy?this.line.attr("stroke",SpectrumViewer.p2color):this.fragments[0].peptide===this.graph.spectrumViewer.pep1&&
!0===this.fragments[0].lossy?this.line.attr("stroke",SpectrumViewer.p1color_loss):this.fragments[0].peptide===this.graph.spectrumViewer.pep2&&!0===this.fragments[0].lossy&&this.line.attr("stroke",SpectrumViewer.p2color_loss);this.highlightLine=this.graph.highlights.append("line").attr("stroke",SpectrumViewer.highlightColour).attr("stroke-width",SpectrumViewer.highlightWidth).attr("opacity","0");this.highlightLine.append("svg:title").text(this.tooltip);var a=this,b=this.line[0][0];b.onmouseover=function(b){a.highlight(!0);
a.graph.highlightChanged.dispatch(a.fragments)};b.onmouseout=function(b){a.highlight(!1);a.graph.highlightChanged.dispatch([])};b.ontouchstart=function(b){a.highlight(!0);a.graph.highlightChanged.dispatch(a.fragments)};b.ontouchend=function(b){a.highlight(!1);a.graph.highlightChanged.dispatch([])};b=this.highlightLine[0][0];b.onmouseover=function(b){a.highlight(!0);a.graph.highlightChanged.dispatch(a.fragments)};b.onmouseout=function(b){a.highlight(!1);a.graph.highlightChanged.dispatch([])};b.ontouchstart=
function(b){a.highlight(!0);a.graph.highlightChanged.dispatch(a.fragments)};b.ontouchend=function(b){a.highlight(!1);a.graph.highlightChanged.dispatch([])};this.labels=[];for(var b=this.fragments.length,d=0;d<b;d++){var c=this.fragments[d],e=this.graph.annotations.append("text").text(c.name).attr("text-anchor","middle").attr("class","peakAnnot"),k="pink",k=this.graph.spectrumViewer.pep1==c.peptide?"p1":"p2",k=-1==c.name.indexOf("_")?SpectrumViewer[k+"color"]:SpectrumViewer[k+"color_loss"];e.attr("fill",
k);e.append("svg:title").text(this.tooltip);this.labels.push(e)}}else this.line.attr("stroke","#777777")};Peak.prototype.highlight=function(a){1==a?this.highlightLine.attr("opacity","1"):this.highlightLine.attr("opacity","0");this.highlighted=a};
Peak.prototype.update=function(){var a=this.graph.x.domain();this.line.attr("x1",this.graph.x(this.x));this.line.attr("y1",this.graph.y(this.y));this.line.attr("x2",this.graph.x(this.x));this.line.attr("y2",this.graph.y(0));if(0<this.fragments.length){this.highlightLine.attr("x1",this.graph.x(this.x));this.highlightLine.attr("y1",this.graph.y(this.y));this.highlightLine.attr("x2",this.graph.x(this.x));this.highlightLine.attr("y2",this.graph.y(0));for(var b=this.labels.length,d=0;d<b;d++){var c=this.labels[d];
c.attr("x",this.graph.x(this.x));c.attr("y",this.graph.y(this.y)-5-15*d)}}this.x>a[0]&&this.x<a[1]?(this.line.attr("display","inline"),0<this.fragments.length&&this.highlightLine.attr("display","inline"),this.showLabels()):(this.line.attr("display","none"),0<this.fragments.length&&this.highlightLine.attr("display","none"),this.removeLabels())};Peak.prototype.removeLabels=function(){if(0<this.fragments.length)for(var a=this.labels.length,b=0;b<a;b++)this.labels[b].attr("display","none")};
Peak.prototype.showLabels=function(){if(0<this.fragments.length)for(var a=this.labels.length,b=0;b<a;b++)!0!==this.graph.spectrumViewer.lossyShown&&!1!==this.fragments[b].lossy&&!0!==this.highlighted||this.labels[b].attr("display","inline")};function Fragment(a){this.name=a.fragment_name.trim();this.peptide=a.matchedpeptide.replace(SpectrumViewer.notUpperCase,"");this.sequence=a.sequence;a=this.name.split("")[0];this.ionType="a"==a||"b"==a||"c"==a?"b":"y";this.ionNumber=/(.(\d*))/g.exec(this.name)[2]-0;this.lossy=!1;-1!=this.name.indexOf("_")&&(this.lossy=!0)};
